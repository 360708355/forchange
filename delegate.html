<!DOCTYPE html>
<html>
	<head>
		<title>复杂事件代理实现机制</title>
		<meta charset="utf-8">
		<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<style type="text/css">
			#box {
				background: blue;
			}
		</style>
	</head>
	<body>
		<div id="box">
			<div class="classA">
				<div class="classB">
					<ul>
						<li>lilili</li>
						<li>lilili</li>
						<li><span>我是深层的span</span></li>
					</ul>
				</div>
				<span>kodo</span>
			</div>
		</div>
		<div class="btn-wrap">
	        <button class="btn-test">.btn-test</button>
	        <button class="btn-with-event-bubbling">.btn-with-event-bubbling</button>
	        <button class="btn-clear">.btn-clear</button>
	    </div>
		<script type="text/javascript">
			var body = document.querySelector("body");
			var box = document.getElementById("box");
			
			/**
			 *  delegate实现与jQuery实现，冒泡target对比测试
			 */
			
			$("body").on('click','.btn-with-event-bubbling',function(e) {
				console.log(e);
				e.stopPropagation();
				console.log(e.currentTarget,'--------currentTarget');
			})
			$("body").on('click','.btn-wrap',function(e) {
				//jq的事件代理  e.currentTarget 指向的是 .btn-wrap
				console.log('jq冒泡触发');
			})
			delegate(body,'click','.btn-with-event-bubbling',function(e) {
				console.log(e.currentTarget,'--------currentTarget');
				return false;
			});
			delegate(body,'click','.btn-wrap',function(e) {
				console.log('delegate冒泡触发');
				//delegate事件代理  e.currentTarget 指向的是 body
			});
			/**
			 * delegate实现与jQuery实现，冒泡target对比测试
			 *   结果相同
			 */
			function delegate(agent,type,selector,fn) {
				//为了复杂的选择器实现
				agent.addEventListener(type,function(e) {
					var target = e.target;
					var ctarget = e.currentTarget;
					var bubble = true;
					while(bubble && target != ctarget) {
						if(filiter(agent,selector,target,e)) {
							bubble = fn.call(target,e);
						};
						target = target.parentNode;
						return bubble;
					}
				},false);
				function filiter(agent,selector,target,e) {
					var nodes = agent.querySelectorAll(selector);
					for (var i = 0; i < nodes.length; i++) {
						if (nodes[i] == target) {
							return true;
						}
					}
				}
			}
		</script>
	</body>
</html>
